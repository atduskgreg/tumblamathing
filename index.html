<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN">
<html>
  <head>
    <title>Tumblmathing</title>
  <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.1/jquery.min.js"></script>
  <script type="text/javascript" src="../grouter/grouter.js"></script>
  <script type="text/javascript" src="../srender/jquery.srender.js"></script>
  <link rel="stylesheet" type="text/css" href="http://assets.tumblr.com/stylesheets/compressed/global.css?99"/>
  <link rel="stylesheet" type="text/css" href="http://assets.tumblr.com/stylesheets/compressed/dashboard.css?99"/>
  <style>
    #container {
      width: 700px;
    }
    
    ol#posts {
      margin: 0;
    }
    
    #header h1 a {
      color: #fff;
      font-size: 50px;
    }
    
    h2 {
      color: #ddd;
      font-size:25px;
    }
    
    h5 {
      background-color:#000000;
      border:1px solid #FFFFFF;
      color:red;
      float:right;
      font-size:20px;
      margin:-50px 0 0;
      padding:2px;
      text-transform:uppercase;
    }
    
    #tumblr-title, #reblogged{
      font-size: 35px;
      color: orange;
      margin: 0;
    }
    
    #tumblr-title {
      text-transform: uppercase;
    }
    
    #reblogged {
      font-style: italic;
    }
    
    form {
      font-size: 30px;
      color: #eee;
    }
    
    input {
      font-size: 25px;
    }

  </style>
  
  </head>
  
  <script type="text/javascript">
    
    Route("/about/:blog", function(params){
      Tmbl.rblgs(params['blog']);  
    });
    
    Route("/search", function(){
      $.srender(Templates.search, {}, $("#content"));
    })
        
    $(function() {
      // hack to reapply events after we rip away 
      function applyEvents(){
        $("#search").submit(function(){
          Router.goTo("/about/" + $("#q").attr("value"));
          applyEvents();
          return false;
        });
        
        $("h1 a").click(function(){
          Router.goTo("/search");
          applyEvents();
          return false;
        });
      }
      Router.route();
      applyEvents();
      
    })
    
    Templates = {
      search :'<form id="search" method="get">\
                <input name="q" id="q" value="" />\
                <label>.tumblr.com</label>\
              </form>',
      reblog : '<div id="left_column">\
                  <h2 >\
                  <span id="tumblr-title"><%= data.tumblog %></span>\
                   was <span id="reblogged">reblogged</span> <%= data.length %> Times</h2>\
                   <% if(Tmbl.ggle.reachedMax) { %>\
                     <h5 id="reached-max">max!</h5>\
                   <% } %>\
                  <ol id="posts">\
                  <% for(x = 0; x < data.length; x++){ %>\
                    <li class="post">\
                      <h4><a href="<%= data[x].url %>"><%= data[x].title  %></a></h4>\
                      &mdash;<%= data[x].domain %>\
                      </li>\
                <% } %>\
                </ol></div><div class="clear"/>'
    }
      
    GResult = function(resultData){
      this.title = resultData.title;
      this.url = resultData.unescapedUrl;
      this.domain = resultData.visibleUrl;
    }
    
    Tmbl = {
      rblgs : function(tumblog){
        Tmbl.ggle.reblogQuery(tumblog, function(data){
          data.tumblog = tumblog;
          this.data = data;
          $.srender(Templates.reblog, data, $("#content"));

          return false;
        })
      },
      
      ggle : {
        results : [],
        expectedPages : 0,
        maxPages : 100,
        processSearchResultsPage : function(data){
          for (i = 0; i < data.responseData.results.length; i++){
            Tmbl.ggle.results.push(new GResult(data.responseData.results[i]));          
          }
        },
        
        reblogQuery : function(subdomain, callback){
          var q = Tmbl.ggle.composeReblogQuery(subdomain);
          Tmbl.ggle.queryGoogle(q, 0, callback);
        },
        
        composeReblogQuery : function(subdomain){
          return "site%3Atumblr.com+-site%3A"+subdomain+".tumblr.com+"+subdomain;
        },
        
        queryGoogle : function(q, p, callback){
          
          var currentPage = p
          var rootUrl = "http://ajax.googleapis.com/ajax/services/search/web?v=1.0&start="+p+"&q=";
          $.getJSON(rootUrl + q + "&callback=?",function(data){
            if(data.responseData){
              Tmbl.ggle.expectedPages = Math.ceil(data.responseData.cursor.estimatedResultCount / 4);
              Tmbl.ggle.processSearchResultsPage(data);
            } else {
              Tmbl.ggle.reachedMax = true;
              callback(Tmbl.ggle.results);
              Tmbl.ggle.reachedMax = false;

              // reset

              Tmbl.ggle.results = [];
              Tmbl.ggle.expectedPages = 0;
              return false;
            }
            
            if(currentPage + 1 < Tmbl.ggle.expectedPages){
              Tmbl.ggle.queryGoogle(q, (currentPage + 1), callback);
            }
            else{
              callback(Tmbl.ggle.results);
              // reset
              Tmbl.ggle.results = [];
              Tmbl.ggle.expectedPages = 0;
            }
            return false;
          });
          return false;
        }
      }
    }
    
  </script>
  <body id="dashboard_index">
    <div id="container">
      
      <div id="header">
        <h1 class="dashboard_header"><a href="/#/search">ReblogRadar</a></h1>
      </div>
      <div id="content">
      </div>
    </div>

  </body>
</html>
